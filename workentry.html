<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>




    <title>Work Entry Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #e5ddd5;
            display: flex;
            justify-content: center;
            margin: 0;
            padding: 0;
        }



        .main-container {
            max-width: 1100px;
            width: 100%;
            padding: 10px;
        }
        /* WhatsApp-style card */
        .card {
            background: #fff;
            border-radius: 20px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            background-image: url("background.png");
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-image: url('https://cdn-icons-png.flaticon.com/512/149/149071.png');
            background-position: center;
            background-size: cover;
            border: 2px solid #25d366;
        }


        .card-header h2 {
            margin: 0;
            color: #075e54;
        }

        .form-group {
            margin-bottom: 12px;
        }

            .form-group label {
                display: block;
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 5px;
                color: white;
            }

            .form-group input {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid #ccc;
                border-radius: 15px;
                outline: none;
                font-size: 14px;
            }

                .form-group input:focus {
                    border-color: #25d366;
                    box-shadow: 0 0 5px rgba(37, 211, 102, 0.4);
                }
        /* Buttons */
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dashboard-btn {
            background: #25d366;
            color: white;
            margin: 8px;
            font-weight: bold;
        }

            .dashboard-btn:hover {
                background: #1eb054;
            }

        .logout-btn {
            background: #ff4d4d;
            color: white;
        }

        .btn-save {
            background: #25d366;
            color: white;
        }

        .btn-delete {
            background: #ff4d4d;
            color: white;
        }

        .btn-view {
            background: #34b7f1;
            color: white;
        }

        .table-wrapper {
            max-height: 900px; /* tamaru required height */
            overflow-x: auto; /* üîë allows horizontal scroll */
            -webkit-overflow-scrolling: touch; /* smooth scrolling on mobile */
        }

            .table-wrapper table {
                min-width: 500px; /* Set a minimum width for table */
                overflow-y: auto; /* vertical scroll */
            }

        /* Table */
        table {
            border-collapse: collapse;
            margin-top: 15px;
            width: 50%;
            height: 100%;
            background: white;
            border-radius: 10px;
            overflow: auto;
            table-layout: fixed; /* üëà fix column width */
            -webkit-overflow-scrolling: touch;
            font-size: 8px; /* ‚úÖ table font size */
        }

            table th, table td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: center;
                word-wrap: break-word; /* üëà text wrap thashe */
                font-size: 12px; /* ‚úÖ cells font size */
            }
        /* Body rows ni height control */
        #entries-table tbody td {
            padding: 2px 4px; /* ochi padding */
            font-size: 10px; /* font size chhoto karo */
            line-height: 1.1; /* row spacing ochi karo */
            height: 20px; /* fixed height, optional */
            vertical-align: middle;
        }


        h2 {
            color: white;
        }

        /* View Entry column widths */
        #entries-table th:nth-child(1),
        #entries-table td:nth-child(1) {
            width: 15px;
        }
        /* # (serial no) */

        #entries-table th:nth-child(2),
        #entries-table td:nth-child(2) {
            width: 50px;
        }
        /* Date */

        #entries-table th:nth-child(3),
        #entries-table td:nth-child(3),
        #entries-table th:nth-child(4),
        #entries-table td:nth-child(4),
        #entries-table th:nth-child(5),
        #entries-table td:nth-child(5),
        #entries-table th:nth-child(6),
        #entries-table td:nth-child(6) {
            width: 35px;
        }
        /* Active/Marking/ReMarking/OutParty */

        #entries-table th:nth-child(7),
        #entries-table td:nth-child(7),
        #entries-table th:nth-child(8),
        #entries-table td:nth-child(8),
        #entries-table th:nth-child(9),
        #entries-table td:nth-child(9),
        #entries-table th:nth-child(10),
        #entries-table td:nth-child(10) {
            width: 45px;
        }
        /* Salaries */

        #entries-table th:nth-child(11),
        #entries-table td:nth-child(11) {
            width: 55px;
        }
        /* Total Salary */


        /* Column widths */
        /* Example: specific column widths */
        #salary-summary th:nth-child(1),
        #salary-summary td:nth-child(1) {
            width: 5%;
        }
        /* SR.NO */
        #salary-summary th:nth-child(2),
        #salary-summary td:nth-child(2) {
            width: 20%;
        }
        /* NAME */
        #salary-summary th:nth-child(3),
        #salary-summary td:nth-child(3) {
            width: 15%;
        }
        /* SALARY */
        #salary-summary th:nth-child(4),
        #salary-summary td:nth-child(4) {
            width: 10%;
        }
        /* WorkDay */
        #salary-summary th:nth-child(5),
        #salary-summary td:nth-child(5) {
            width: 15%;
        }
        /* NetSalary */
        #salary-summary th:nth-child(6),
        #salary-summary td:nth-child(6) {
            width: 10%;
        }
        /* Withdrw */
        #salary-summary th:nth-child(7),
        #salary-summary td:nth-child(7) {
            width: 10%;
        }
        /* BankSalary */
        #salary-summary th:nth-child(8),
        #salary-summary td:nth-child(8) {
            width: 15%;
        }
        /* Pay in Cash */

        /* Common input styling */
        .salary-input, .workday-input {
            width: 55px; /* üëà nana width */
            padding: 4px 6px;
            font-size: 16px;
            text-align: center;
            border: 1px solid #999;
            border-radius: 6px;
        }

        th {
            background: #075e54;
            color: white;
            padding: 10px;
        }

        td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        tfoot th {
            background: #25d366;
            color: white;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 6px;
            margin: 2px;
        }

        .month-filter label {
            color: white;
            font-weight: bold;
        }

        .month-filter input[type="month"] {
            color: white; /* ‡™≤‡™ñ‡™æ‡™£ ‡™∏‡™´‡´á‡™¶ */
            background: #075e54; /* ‡™°‡™æ‡™∞‡´ç‡™ï ‡™¨‡´á‡™ï‡™ó‡´ç‡™∞‡™æ‡™â‡™®‡´ç‡™° */
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 4px 6px;
        }

        .btn-small {
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
            display: inline-block; /* horizontal layout mate */
            margin-right: 4px; /* button vachche gap */
            vertical-align: middle; /* text vertically center */
        }

        .button-group {
            display: flex;
            gap: 4px; /* button vachche gap */
            justify-content: flex-start; /* left side align karva */
            align-items: center; /* vertically center */
        }
        #glass-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0%;
            overflow: hidden;
        }

        .diamond {
            position: absolute;
            font-size: 8px; /* ‡™®‡™æ‡™®‡™æ diamonds */
            color: #00e5ff;
            text-shadow: 0 0 2px #aef, 0 0 4px #aef;
            animation: sparkle 2s infinite alternate;
        }

        @keyframes sparkle {
            from {
                opacity: 0.7;
                transform: scale(0.9) rotate(0deg);
            }

            to {
                opacity: 1;
                transform: scale(1.1) rotate(15deg);
            }
        }
        /* Mobile responsive: screen <= 480px */
        @media screen and (max-width: 480px) {
            #dashboard-summary {
                flex-direction: column;
                align-items: center;
            }

                #dashboard-summary > div {
                    flex: 0 0 auto;
                    width: 90%;
                    margin-bottom: 10px;
                }
        }


        

    </style>
</head>
<body>

    <div class="main-container">


        <!-- Dashboard -->
        <div id="dashboard" class="section card" style="text-align: center; color: white;">
            <h2>Dashboard</h2>
            <div id="dashboard-summary"
                 style="margin-top:5px; font-size:16px; font-weight:bold;
display:flex; justify-content:center; align-items:flex-start; flex-wrap:wrap; gap:10px;">

                <!-- Left Side: Summary + Chart -->
                <div style="flex:0 0 200px; min-width:180px; text-align:left; color:white;">
                    <p id="present-days" style="margin:2px 0;">Present Days: 0</p>
                    <p id="absent-days" style="margin:2px 0;">Absent Days: 0</p>
                    <p id="total-salary" style="margin:2px 0;">Total Salary: 0</p>
                    <p id="salary-emoji" style="font-size:40px; margin:5px 0;"></p>

                    <!-- Doughnut Chart aligned left -->
                    <div style="width:160px; height:160px; margin:5px 0;">
                        <canvas id="attendanceChart"></canvas>
                    </div>
                </div>

                <!-- üíé Right Side: Target Glass -->
                <div style="flex:0 0 180px; min-width:160px; text-align:center;">
                    <h3 style="color:white; font-size:16px;">üéØ Monthly Target</h3>

                    <!-- Target Input -->
                    <input type="number" id="user-target" placeholder="Enter Target (‚Çπ)"
                           style="width:120px; padding:4px; font-size:12px; border-radius:6px; text-align:center;">
                    <button onclick="setTarget()"
                            style="margin-left:5px; padding:4px 8px; font-size:12px; border-radius:6px; background:#25d366; color:white; border:none;">
                        Set
                    </button>

                    <!-- Glass Tube -->
                    <div style="position:relative; width:80px; height:200px; margin:5px auto;
border:2px solid #075e54; border-radius:40px; overflow:hidden; background:#f0f0f0;">
                        <div id="glass-fill"
                             style="position:absolute; bottom:0; left:0; width:100%; height:0%;
    display:flex; flex-wrap:wrap; align-content:flex-start; gap:2px; padding:2px; overflow:hidden;">
                            <!-- Diamonds dynamically add thase -->
                        </div>
                    </div>
                    <p id="target-text" style="margin-top:5px; font-weight:bold; color:white; font-size:14px;">
                        0 / 0 ‚Çπ
                    </p>
                </div>
            </div>



            <button class="dashboard-btn" onclick="showSection('add-entry')">‚ûï Add Entry</button>
            <button class="dashboard-btn" onclick="showEntries()">üìÑ View Entry</button>
            <button class="dashboard-btn" onclick="showSection('update-profile')">üõ† Update Profile</button>
            <button class="dashboard-btn" style="background:#34b7f1;" onclick="showSection('manage-salary')">üí∞ Manage Salary</button>
            <button class="dashboard-btn logout-btn" onclick="logout()">üö™ Logout</button>
        </div>

        <!-- Add Entry -->
        <div id="add-entry" class="section card" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Add Work Entry</h2>
                <button class="logout-btn" onclick="showSection('dashboard')">‚¨Ö Back</button>
            </div>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="name" readonly>
                <label>Date:</label>
                <input type="date" id="date" value="">
            </div>
            <div class="form-group"><label>ActivePart:</label><input type="number" id="active"></div>
            <div class="form-group"><label>Marking:</label><input type="number" id="marking"></div>
            <div class="form-group"><label>ReMarking:</label><input type="number" id="remarking"></div>
            <div class="form-group"><label>OutParty:</label><input type="number" id="outparty"></div>
            <div>
                <button class="btn-save" onclick="saveEntry()">üíæ Save Entry</button>
            </div>
        </div>


        <!-- View Entry -->
        <div id="view-entry" class="section card card-white" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>All Entries</h2>
                <div>
                    <button class="btn-delete" onclick="deleteAllEntries()">üóë Delete All Entries</button>
                    <button class="logout-btn" onclick="showSection('dashboard')">‚¨Ö Back</button>
                </div>
                <div class="month-filter" style="margin-bottom:10px;">
                    <label for="monthFilter"><b>Filter by Month:</b></label>
                    <input type="month" id="monthFilter" onchange="showEntries()" />
                </div>
                <button class="dashboard-btn" style="background:#075e54;" onclick="exportTableToPDF()">üñ® Export to PDF</button>


            </div>
            <div class="table-wrapper">
                <table id="entries-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Active</th>
                            <th>Marking</th>
                            <th>ReMarking</th>
                            <th>OutParty</th>
                            <th>ActivePartSalary</th>
                            <th>MarkingSalary</th>
                            <th>ReMarkingSalary</th>
                            <th>OutPartySalary</th>
                            <th>TotalSalary</th>
                        </tr>
                    </thead>
                    <tbody id="entries-body"></tbody>
                    <tfoot>
                        <tr id="total-row">
                            <th colspan="2">TOTAL</th>
                            <th id="t-active">0</th>
                            <th id="t-marking">0</th>
                            <th id="t-remarking">0</th>
                            <th id="t-outparty">0</th>
                            <th id="t-activeSalary">0.00</th>
                            <th id="t-markingSalary">0.00</th>
                            <th id="t-remarkingSalary">0.00</th>
                            <th id="t-outpartySalary">0.00</th>
                            <th id="t-totalSalary">0.00</th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>



            <!-- Update Profile -->
            <div id="update-profile" class="section card card-white" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Update Profile</h2>
                    <button class="logout-btn" onclick="showSection('dashboard')">‚¨Ö Back</button>
                </div>
                <div class="form-group">
                    <label>User name:</label>
                    <input type="text" id="username">
                    <label>New Password:</label>
                    <input type="password" id="password">
                </div>
                <button class="update-btn" onclick="updateProfile()">üîí Update Profile</button>
            </div>
            <!-- Manage Salary -->
            <div id="manage-salary" class="section card" style="display:none;">
                <h2>Manage Salary & Summary</h2>
                <button class="logout-btn" onclick="showSection('dashboard')">‚¨Ö Back</button>
                <div class="table-wrapper">
                    <table id="salary-summary">
                        <thead>
                            <tr>
                                <th>SR.NO</th>
                                <th>NAME (Full Name)</th>
                                <th>SALARY (Total)</th>
                                <th>WorkDay</th>
                                <th>NetSalary</th>
                                <th>Withdrw</th>
                                <th>BankSalary</th>
                                <th>Pay In Cash</th>
                            </tr>
                        </thead>
                        <tbody id="salary-body"></tbody>
                    </table>

                    <!-- ‚úÖ Withdraw History Box (inside Manage Salary only) -->
                    <div class="card" style="margin-top:20px;">
                        <h3 style="color:#075e54;">üí≥ Withdraw History</h3>
                        <table id="withdraw-history">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date & Time</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="withdraw-body">
                                <tr><td colspan="3" style="text-align:center; color:gray;">No withdraw history</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

    <script>



        const firebaseConfig = {
            apiKey: "AIzaSyBcevmTwJ7T6xid6s-4csUm4UiFKUn7q_Q",
            authDomain: "my-work-update.firebaseapp.com",
            projectId: "my-work-update",
            storageBucket: "my-work-update.appspot.com", // ‚úÖ FIX
            messagingSenderId: "521466697898",
            appId: "1:521466697898:web:071cb3372c2d686ead98d3"
        };

        window.onload = function () {
            let loggedUser = JSON.parse(localStorage.getItem('loggedUser') || '{}');

            // admin user manage ‡™Æ‡™æ‡™Ç save ‡™•‡™Ø‡´á‡™≤ fullname field load ‡™ï‡™∞‡´ã
            if (loggedUser.fullname && loggedUser.fullname.trim() !== "") {
                document.getElementById('name').value = loggedUser.fullname;
            } else if (loggedUser.fullName && loggedUser.fullName.trim() !== "") {
                // ‡™ú‡´ã ‡™ï‡´ç‡™Ø‡™æ‡™Ç‡™ï fullName key ‡™•‡´Ä save ‡™•‡™Ø‡´á‡™≤‡´Å‡™Ç ‡™π‡´ã‡™Ø ‡™§‡´ã fallback
                document.getElementById('name').value = loggedUser.fullName;
            } else if (loggedUser.username) {
                document.getElementById('name').value = loggedUser.username;
            } else {
                document.getElementById('name').value = "";
            }
            {
                loadWithdrawHistory();
                loadDashboardSummary();
            };
        };

        function logout() {
            if (confirm("Do you really want to logout?")) {
                localStorage.removeItem("loggedUser");
                window.location.href = "index.html";
            }
        }
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if (id === 'manage-salary') {
                loadSalarySummary();
            }
        }


        async function saveEntry() {
            let name = document.getElementById('name').value.trim();
            let date = document.getElementById('date').value;

            let active = +document.getElementById('active').value.trim() || 0;
            let marking = +document.getElementById('marking').value.trim() || 0;
            let remarking = +document.getElementById('remarking').value.trim() || 0;
            let outparty = +document.getElementById('outparty').value.trim() || 0;

            if (!name || !date) {
                alert("‚ùå Please fill Name and Date");
                return;
            }

            if (active === 0 && marking === 0 && remarking === 0 && outparty === 0) {
                alert("Please enter your pcs");
                return;
            }

            let rates = { active: 2.6, marking: 2.3, remarking: 3.0, outparty: 2.6 };
            let activeSalary = active * rates.active;
            let markingSalary = marking * rates.marking;
            let remarkingSalary = remarking * rates.remarking;
            let outpartySalary = outparty * rates.outparty;
            let totalSalary = activeSalary + markingSalary + remarkingSalary + outpartySalary;

            let entry = {
                name, date, active, marking, remarking, outparty,
                activeSalary, markingSalary, remarkingSalary, outpartySalary,
                total: totalSalary,
                createdAt: new Date()
            };

            // üîπ Unique docId = name + date
            let docId = name + "_" + date;
            let docRef = db.collection("workEntries").doc(docId);

            try {
                let snap = await docRef.get();

                if (snap.exists) {
                    // üîπ If already exists, ask user before overwrite
                    if (confirm("‚ö†Ô∏è Aa entry pahelathi save che.\nTamne overwrite karvu che?")) {
                        await docRef.set(entry, { merge: true });
                        alert("‚úÖ Entry updated successfully!");
                        resetForm();
                    } else {
                        alert("‚ùå Entry overwrite cancel kari.");
                    }
                } else {
                    // üîπ New entry
                    await docRef.set(entry);
                    alert("‚úÖ New entry saved successfully!");
                    resetForm();
                }
            } catch (error) {
                console.error("‚ùå Error saving entry:", error);
                alert("Error saving entry. Check console.");
            }
        }

        // üßπ Reset function
        function resetForm() {
            document.getElementById('date').value = "";
            document.getElementById('active').value = "";
            document.getElementById('marking').value = "";
            document.getElementById('remarking').value = "";
            document.getElementById('outparty').value = "";
        }

        function showEntries() {
            showSection('view-entry');

            let loggedUser = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            let userName = loggedUser.fullname || loggedUser.fullName || loggedUser.username;

            let tbody = document.getElementById('entries-body');
            tbody.innerHTML = '';

            // Month filter
            let monthFilter = document.getElementById("monthFilter").value;
            let now = new Date();
            let currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            if (!monthFilter) monthFilter = currentMonth;

            db.collection("workEntries")
                .where("name", "==", userName)
                .get()
                .then(snapshot => {
                    let entries = [];
                    snapshot.forEach(doc => {
                        let data = doc.data();
                        data.id = doc.id;
                        let entryMonth = new Date(data.date).toISOString().slice(0, 7);
                        if (entryMonth === monthFilter) entries.push(data);
                    });

                    if (entries.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="13" style="text-align:center;color:gray;">No entries for this month</td></tr>`;
                        resetTotals();
                        // üü¢ salary reset if no entries
                        localStorage.setItem("monthlyTotalSalary", "0");
                        return;
                    }

                    // üîπ Group entries by date
                    let entriesByDate = {};
                    entries.forEach(e => {
                        let d = new Date(e.date);
                        let key = d.toISOString().slice(0, 10); // YYYY-MM-DD
                        if (!entriesByDate[key]) entriesByDate[key] = [];
                        entriesByDate[key].push(e);
                    });

                    // üîπ Get all dates of the month
                    let [year, month] = monthFilter.split("-").map(Number);
                    let daysInMonth = new Date(year, month, 0).getDate();
                    let i = 1;
                    let total = {
                        active: 0, marking: 0, remarking: 0, outparty: 0,
                        activeSalary: 0, markingSalary: 0, remarkingSalary: 0,
                        outpartySalary: 0, totalSalary: 0
                    };

                    for (let day = 1; day <= daysInMonth; day++) {
                        let dd = String(day).padStart(2, '0');
                        let mm = String(month).padStart(2, '0');
                        let displayDate = `${dd}-${mm}-${year}`;
                        let key = `${year}-${mm}-${dd}`;

                        let dayEntries = entriesByDate[key] || [];

                        if (dayEntries.length === 0) {
                            // Week Off row in red
                            tbody.innerHTML += `
<tr>
  <td>${i++}</td>
  <td>${displayDate}</td>
  <td colspan="10" style="text-align:center;color:red;font-weight:bold;">Week Off</td>
</tr>`;
                            continue;
                        }

                        // üîπ Render actual entries
                        dayEntries.forEach(e => {
                            let d = new Date(e.date);
                            let dd1 = String(d.getDate()).padStart(2, '0');
                            let mm1 = String(d.getMonth() + 1).padStart(2, '0');
                            let yyyy = d.getFullYear();
                            let displayDateEntry = `${dd1}-${mm1}-${yyyy}`;

                            tbody.innerHTML += `
<tr>
  <td>${i++}</td>
  <td>${displayDateEntry}</td>
  <td>${e.active || 0}</td>
  <td>${e.marking || 0}</td>
  <td>${e.remarking || 0}</td>
  <td>${e.outparty || 0}</td>
  <td>${(e.activeSalary || 0).toFixed(2)}</td>
  <td>${(e.markingSalary || 0).toFixed(2)}</td>
  <td>${(e.remarkingSalary || 0).toFixed(2)}</td>
  <td>${(e.outpartySalary || 0).toFixed(2)}</td>
  <td>${(e.total || 0).toFixed(2)}</td>
  <td>
    <div class="button-group">
        <button class="btn-save btn-small" onclick="editEntry('${e.id}')">‚úè</button>
        <button class="btn-delete btn-small" onclick="deleteEntry('${e.id}')">üóë</button>
    </div>
</td>
</tr>`;

                            // Add to monthly totals
                            total.active += e.active || 0;
                            total.marking += e.marking || 0;
                            total.remarking += e.remarking || 0;
                            total.outparty += e.outparty || 0;
                            total.activeSalary += e.activeSalary || 0;
                            total.markingSalary += e.markingSalary || 0;
                            total.remarkingSalary += e.remarkingSalary || 0;
                            total.outpartySalary += e.outpartySalary || 0;
                            total.totalSalary += e.total || 0;
                        });
                    }

                    // üîπ Update totals row
                    document.getElementById('t-active').textContent = total.active;
                    document.getElementById('t-marking').textContent = total.marking;
                    document.getElementById('t-remarking').textContent = total.remarking;
                    document.getElementById('t-outparty').textContent = total.outparty;
                    document.getElementById('t-activeSalary').textContent = total.activeSalary.toFixed(2);
                    document.getElementById('t-markingSalary').textContent = total.markingSalary.toFixed(2);
                    document.getElementById('t-remarkingSalary').textContent = total.remarkingSalary.toFixed(2);
                    document.getElementById('t-outpartySalary').textContent = total.outpartySalary.toFixed(2);
                    document.getElementById('t-totalSalary').textContent = total.totalSalary.toFixed(2);

                    // ‚úÖ Save monthly salary in localStorage
                    localStorage.setItem("monthlyTotalSalary", total.totalSalary.toFixed(2));
                })
                .catch(error => {
                    console.error("‚ùå Firestore query error:", error);
                    alert("Error fetching entries. Check console.");
                });

            function resetTotals() {
                document.getElementById('t-active').textContent = 0;
                document.getElementById('t-marking').textContent = 0;
                document.getElementById('t-remarking').textContent = 0;
                document.getElementById('t-outparty').textContent = 0;
                document.getElementById('t-activeSalary').textContent = "0.00";
                document.getElementById('t-markingSalary').textContent = "0.00";
                document.getElementById('t-remarkingSalary').textContent = "0.00";
                document.getElementById('t-outpartySalary').textContent = "0.00";
                document.getElementById('t-totalSalary').textContent = "0.00";

                // reset localStorage salary also
                localStorage.setItem("monthlyTotalSalary", "0");
            }
        }




        // Edit ‚Üí load into Add Entry form
        function editEntry(docId) {
            db.collection("workEntries").doc(docId).get().then(doc => {
                if (doc.exists) {
                    let e = doc.data();
                    document.getElementById('date').value = e.date;
                    document.getElementById('active').value = e.active;
                    document.getElementById('marking').value = e.marking;
                    document.getElementById('remarking').value = e.remarking;
                    document.getElementById('outparty').value = e.outparty;

                    // store current editing ID
                    localStorage.setItem("editingDocId", docId);

                    showSection('add-entry');
                }
            });
        }

        // Delete ‚Üí remove from Firestore
        function deleteEntry(docId) {
            if (!confirm("‚ö†Ô∏è Are you sure you want to delete this entry?")) return;
            db.collection("workEntries").doc(docId).delete()
                .then(() => {
                    alert("‚úÖ Entry deleted successfully!");
                    showEntries();
                })
                .catch(err => {
                    console.error("‚ùå Error deleting entry:", err);
                    alert("Error deleting entry.");
                });
        }




        function deleteAllEntries() {
            if (!confirm("‚ö†Ô∏è Are you sure you want to delete all your entries?")) return;

            let loggedUser = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            let userName = loggedUser.fullname || loggedUser.fullName || loggedUser.username;

            if (!userName) {
                alert("‚ùå User not found. Please login again.");
                return;
            }

            db.collection("workEntries").where("name", "==", userName).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        alert("‚ÑπÔ∏è No entries found to delete.");
                        return;
                    }

                    let batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    alert("‚úÖ All entries deleted successfully!");
                    document.getElementById('entries-body').innerHTML = ""; // clear table
                    // Reset totals
                    document.getElementById('t-active').textContent = 0;
                    document.getElementById('t-marking').textContent = 0;
                    document.getElementById('t-remarking').textContent = 0;
                    document.getElementById('t-outparty').textContent = 0;
                    document.getElementById('t-activeSalary').textContent = "0.00";
                    document.getElementById('t-markingSalary').textContent = "0.00";
                    document.getElementById('t-remarkingSalary').textContent = "0.00";
                    document.getElementById('t-outpartySalary').textContent = "0.00";
                    document.getElementById('t-totalSalary').textContent = "0.00";
                })
                .catch(error => {
                    console.error("Error deleting entries: ", error);
                    alert("‚ùå Error deleting entries. Check console.");
                });
        }



        async function updateProfile() {
            let newUsername = document.getElementById("username").value.trim();
            let newPassword = document.getElementById("password").value.trim();
            let currentUser = JSON.parse(localStorage.getItem("loggedUser") || "null");

            if (!currentUser) {
                alert("‡™Ø‡´Ç‡™ù‡™∞ ‡™Æ‡™≥‡´ç‡™Ø‡´ã ‡™®‡™•‡´Ä. ‡™´‡™∞‡´Ä‡™•‡´Ä login ‡™ï‡™∞‡´ã.");
                return;
            }
            if (!newUsername || !newPassword) {
                alert("‡™®‡™µ‡´Å‡™Ç Username ‡™Ö‡™®‡´á Password ‡™®‡™æ‡™ñ‡´ã.");
                return;
            }

            try {
                // üîπ check old record
                let oldUsername = currentUser.username;

                // ‡™ú‡´ã username ‡™¨‡™¶‡™≤‡™æ‡™à ‡™ó‡™Ø‡´ã ‡™π‡´ã‡™Ø ‡™§‡´ã ‚Üí ‡™®‡™µ‡´ã doc ‡™¨‡™®‡™æ‡™µ‡™µ‡´ã ‡™Ö‡™®‡´á ‡™ú‡´Ç‡™®‡´ã delete ‡™ï‡™∞‡™µ‡´ã
                if (newUsername !== oldUsername) {
                    // ‡™®‡™µ‡™æ doc ‡™Æ‡™æ‡™Ç save ‡™ï‡™∞‡´ã
                    await db.collection("users").doc(newUsername).set({
                        username: newUsername,
                        fullname: currentUser.fullname || "",
                        password: newPassword
                    });

                    // ‡™ú‡´Ç‡™®‡´ã doc delete ‡™ï‡™∞‡´ã
                    await db.collection("users").doc(oldUsername).delete();

                    // localStorage ‡™Ö‡™™‡™°‡´á‡™ü
                    currentUser.username = newUsername;
                    currentUser.password = newPassword;
                    localStorage.setItem("loggedUser", JSON.stringify(currentUser));

                    alert("‚úÖ Username & Password update ‡™•‡™Ø‡™æ (‡™®‡™µ‡´Å‡™Ç username ‡™¨‡™®‡™æ‡™µ‡™æ‡™Ø‡´Å‡™Ç).");
                } else {
                    // ‡™Æ‡™æ‡™§‡´ç‡™∞ password update
                    await db.collection("users").doc(oldUsername).update({
                        password: newPassword
                    });

                    currentUser.password = newPassword;
                    localStorage.setItem("loggedUser", JSON.stringify(currentUser));

                    alert("‚úÖ Password ‡™∏‡™´‡™≥‡™§‡™æ‡™™‡´Ç‡™∞‡´ç‡™µ‡™ï update ‡™•‡™Ø‡´ã.");
                }

                // Update form fields
                document.getElementById("username").value = currentUser.username;
                document.getElementById("password").value = "";

            } catch (err) {
                console.error("‚ùå Error updating profile:", err);
                alert("Error updating profile. Console ‡™ú‡´Å‡™ì.");
            }
        }


        async function loadSalarySummary() {
            let loggedUser = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            let userName = loggedUser.fullname || loggedUser.fullName || loggedUser.username;

            try {
                // üîπ First check if filtered monthly salary is stored
                let monthlySalary = localStorage.getItem("monthlyTotalSalary");
                let totalSalary = 0;

                if (monthlySalary) {
                    totalSalary = parseFloat(monthlySalary) || 0;
                } else {
                    // fallback ‚Üí old method (all entries)
                    let snapshot = await db.collection("workEntries")
                        .where("name", "==", userName).get();

                    snapshot.forEach(doc => {
                        let e = doc.data();
                        if (e.total !== undefined) {
                            totalSalary += e.total;
                        } else {
                            totalSalary += (e.activeSalary || 0) + (e.markingSalary || 0) +
                                (e.remarkingSalary || 0) + (e.outpartySalary || 0);
                        }
                    });
                }

                // üîπ Get payments info
                let payDoc = await db.collection("payments").doc(userName).get();
                let pay = payDoc.exists ? payDoc.data() : { workDays: 0, withdrw: 0, bank: 0 };

                let tbody = document.getElementById('salary-body');
                tbody.innerHTML = '';

                let payInCash = totalSalary - (pay.withdrw || 0) - (pay.bank || 0);

                tbody.innerHTML += `
            <tr>
                <td>1</td>
                <td>${userName}</td>
                <td>${totalSalary.toFixed(2)}</td>
                <td>${pay.workDays}</td>
                <td>${totalSalary.toFixed(2)}</td>
                <td>${pay.withdrw}</td>
                <td>${pay.bank}</td>
                <td>${payInCash.toFixed(2)}</td>
            </tr>`;
            } catch (error) {
                console.error("‚ùå Error fetching salary summary:", error);
                alert("Error fetching salary summary.");
            }
        }








        async function updateBaki(input) {
            let row = input.closest('tr');
            let name = row.dataset.name;
            let totalSalary = parseFloat(row.cells[2].textContent) || 0;
            let salaryPerDay = totalSalary / 26;

            let workDays = parseFloat(row.cells[3].querySelector('input').value) || 0;
            let withdrw = parseFloat(row.cells[5].querySelector('input').value) || 0;
            let bank = parseFloat(row.cells[6].querySelector('input').value) || 0;

            let netSalary = salaryPerDay * workDays;
            row.querySelector('.net-salary').textContent = netSalary.toFixed(2);

            let payInCash = netSalary - withdrw - bank;
            row.querySelector('.cash').textContent = payInCash.toFixed(2);

            try {
                let docRef = db.collection("payments").doc(name);
                let docSnap = await docRef.get();
                let oldData = docSnap.exists ? docSnap.data() : { workDays: 0, withdrw: 0, bank: 0, history: [] };

                let oldWithdrw = oldData.withdrw || 0;
                let history = oldData.history || [];

                // ‚úÖ If withdraw increased ‚Üí add history
                if (withdrw > oldWithdrw) {
                    let newAmount = withdrw - oldWithdrw;
                    history.push({
                        date: new Date().toLocaleString(),
                        amount: newAmount
                    });
                }

                await docRef.set({
                    workDays,
                    withdrw,
                    bank,
                    history
                }, { merge: true });  // üîπ safe replace

                console.log("‚úÖ Payment updated in Firestore:", name);

            } catch (err) {
                console.error("‚ùå Firestore update error:", err);
            }
        }





        // ‚úÖ User side ‚Üí ‡™™‡´ã‡™§‡™æ‡™®‡™æ withdraw history show ‡™ï‡™∞‡™µ‡´Å‡™Ç
        async function loadWithdrawHistory(userName) {
            let historyTableBody = document.getElementById("withdraw-body");
            historyTableBody.innerHTML = "";
            let sr = 1;

            try {
                let docSnap = await db.collection("payments").doc(userName).get();
                if (docSnap.exists && docSnap.data().history) {
                    let history = docSnap.data().history;
                    // latest entry ‡™â‡™™‡™∞‡™•‡´Ä ‡™¨‡™§‡™æ‡™µ‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á reverse
                    history.slice().reverse().forEach(h => {
                        let row = document.createElement("tr");
                        row.innerHTML = `
                    <td>${sr++}</td>
                    <td>${h.date}</td>
                    <td>${h.amount.toFixed(2)}</td>
                `;
                        historyTableBody.appendChild(row);
                    });
                }

                if (historyTableBody.innerHTML === "") {
                    historyTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:gray;">No Withdrawals Yet</td></tr>`;
                }
            } catch (err) {
                console.error("‚ùå Error loading withdraw history:", err);
            }
        }






        async function loadWithdrawDetails() {
            let tableBody = document.getElementById("withdrawDetailsBody");
            tableBody.innerHTML = "";

            try {
                let snapshot = await db.collection("payments").get();
                snapshot.forEach(doc => {
                    let data = doc.data();
                    if (data.history) {
                        data.history.forEach(h => {
                            let tr = document.createElement("tr");
                            tr.innerHTML = `
                        <td>${doc.id}</td>
                        <td>${h.date}</td>
                        <td>${h.amount.toFixed(2)}</td>
                    `;
                            tableBody.appendChild(tr);
                        });
                    }
                });

                if (tableBody.innerHTML === "") {
                    tableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:gray;">No Withdrawals Yet</td></tr>`;
                }
            } catch (err) {
                console.error("‚ùå Error loading withdraw details:", err);
            }
        }
        function exportTableToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // Logged-in user ni info
            let loggedUser = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            let userName = loggedUser.fullname || loggedUser.fullName || loggedUser.username || 'User';

            // Header
            doc.setFontSize(12);
            doc.text(`Work Entries - ${userName}`, 14, 10); // User name upar display

            doc.autoTable({
                startY: 15,            // start top thi 15mm upar
                html: '#entries-table',
                theme: 'grid',
                headStyles: { fillColor: [7, 94, 84], textColor: 255 },
                styles: {
                    fontSize: 8,
                    cellPadding: 1       // row height compact
                },
                tableWidth: 'auto',
                pageBreak: 'avoid',
                showHead: 'everyPage'
            });

            doc.save("work_entries.pdf");
        }
       

        // ‚úÖ User-defined target setter
        // üéØ User target set function
        function setTarget() {
            let loggedUser = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            let userName = loggedUser.username || loggedUser.fullname || loggedUser.fullName;

            if (!userName) return;

            let val = parseFloat(document.getElementById("user-target").value) || 0;
            if (val > 0) {
                // user-specific target save
                localStorage.setItem("target_" + userName, val);
                loadDashboardSummary(); // refresh view
            }
        }

        async function loadDashboardSummary() {
            let loggedUser = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            let userName = loggedUser.fullname || loggedUser.fullName || loggedUser.username;
            if (!userName) return;

            let monthFilter = new Date().toISOString().slice(0, 7);
            let entries = [];

            try {
                let snapshot = await db.collection("workEntries")
                    .where("name", "==", userName).get();

                snapshot.forEach(doc => {
                    let data = doc.data();
                    let entryMonth = new Date(data.date).toISOString().slice(0, 7);
                    if (entryMonth === monthFilter) entries.push(data);
                });

                let now = new Date();
                let year = now.getFullYear();
                let month = now.getMonth() + 1;
                let daysInMonth = new Date(year, month, 0).getDate();

                let entriesByDate = {};
                entries.forEach(e => {
                    let d = new Date(e.date);
                    let key = d.toISOString().slice(0, 10);
                    if (!entriesByDate[key]) entriesByDate[key] = [];
                    entriesByDate[key].push(e);
                });

                let present = 0, absent = 0, totalSalary = 0;
                for (let day = 1; day <= daysInMonth; day++) {
                    let dd = String(day).padStart(2, '0');
                    let mm = String(month).padStart(2, '0');
                    let key = `${year}-${mm}-${dd}`;

                    if (entriesByDate[key]) {
                        present++;
                        entriesByDate[key].forEach(e => totalSalary += e.total || 0);
                    } else {
                        absent++;
                    }
                }

                // Salary color + emoji logic
                let salaryColor = "green";
                let emoji = "üòä";
                if (totalSalary < 25000) {
                    salaryColor = "red";
                    emoji = "üò¢";
                } else if (totalSalary >= 25000 && totalSalary <= 30000) {
                    salaryColor = "orange";
                    emoji = "üôÇ";
                } else {
                    salaryColor = "green";
                    emoji = "üòÉ";
                }

                // Update DOM
                document.getElementById("present-days").textContent = `Present Days: ${present}`;
                document.getElementById("absent-days").textContent = `Absent Days: ${absent}`;
                document.getElementById("total-salary").innerHTML =
                    `Total Salary: <span style="color:${salaryColor};">${totalSalary.toFixed(2)}</span>`;
                document.getElementById("salary-emoji").textContent = emoji;

                // ‚úÖ User-specific Target logic with diamonds
                let monthlyTarget = parseFloat(localStorage.getItem("target_" + userName)) || 30000;
                let percentage = Math.min((totalSalary / monthlyTarget) * 100, 100);

                let glassFill = document.getElementById("glass-fill");
                let targetText = document.getElementById("target-text");

                if (glassFill && targetText) {
                    glassFill.style.height = percentage + "%";

                    let maxDiamonds = 700;
                    let diamondCount = Math.floor((percentage / 100) * maxDiamonds);

                    glassFill.innerHTML = "";

                    let tubeWidth = glassFill.clientWidth;
                    let tubeHeight = glassFill.clientHeight;

                    for (let i = 0; i < diamondCount; i++) {
                        let d = document.createElement("span");
                        d.classList.add("diamond");
                        d.textContent = "üíé";

                        d.style.position = "absolute";
                        d.style.left = (Math.random() * (tubeWidth - 10)) + "px";
                        d.style.bottom = (Math.random() * (tubeHeight - 10)) + "px";

                        glassFill.appendChild(d);
                    }

                    targetText.textContent = `${totalSalary.toFixed(2)} / ${monthlyTarget} ‚Çπ`;
                    if (percentage >= 100) {
                        targetText.textContent = `üéâ Target Completed! ${totalSalary.toFixed(2)} ‚Çπ`;
                    }
                }

                // ‚úÖ Chart.js Graph (safe destroy)
                let ctx = document.getElementById('attendanceChart').getContext('2d');
                if (!ctx) {
                    console.error("‚ö†Ô∏è attendanceChart canvas not found!");
                    return;
                }
                if (window.attendanceChart && typeof window.attendanceChart.destroy === "function") {
                    window.attendanceChart.destroy();
                }

                window.attendanceChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Present', 'Absent'],
                        datasets: [{
                            data: [present, absent],
                            backgroundColor: ['#25d366', '#ff4d4d'],
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#ffffff',
                                    font: { size: 14, weight: 'bold' }
                                },
                                onClick: (e) => e.stopPropagation()
                            }
                        }
                    }
                });

            } catch (err) {
                console.error("‚ùå Error loading dashboard summary:", err);
            }
        }











        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();





        // Set today's date in Add Entry form
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
    </script>

</body>
</html>
