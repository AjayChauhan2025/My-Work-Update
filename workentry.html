<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore-compat.js"></script>

    <title>Work Entry Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #e5ddd5;
            display: flex;
            justify-content: center;
            margin: 0;
            padding: 0;
        }

        .main-container {
            max-width: 1100px;
            width: 100%;
            padding: 10px;
        }
        /* WhatsApp-style card */
        .card {
            background: #fff;
            border-radius: 20px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-image: url('https://cdn-icons-png.flaticon.com/512/149/149071.png');
            background-position: center;
            background-size: cover;
            border: 2px solid #25d366;
        }


        .card-header h2 {
            margin: 0;
            color: #075e54;
        }

        .form-group {
            margin-bottom: 12px;
        }

            .form-group label {
                display: block;
                font-weight: bold;
                font-size: 14px;
                margin-bottom: 5px;
                color: #075e54;
            }

            .form-group input {
                width: 100%;
                padding: 10px 12px;
                border: 1px solid #ccc;
                border-radius: 15px;
                outline: none;
                font-size: 14px;
            }

                .form-group input:focus {
                    border-color: #25d366;
                    box-shadow: 0 0 5px rgba(37, 211, 102, 0.4);
                }
        /* Buttons */
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .dashboard-btn {
            background: #25d366;
            color: white;
            margin: 8px;
            font-weight: bold;
        }

            .dashboard-btn:hover {
                background: #1eb054;
            }

        .logout-btn {
            background: #ff4d4d;
            color: white;
        }

        .btn-save {
            background: #25d366;
            color: white;
        }

        .btn-delete {
            background: #ff4d4d;
            color: white;
        }

        .btn-view {
            background: #34b7f1;
            color: white;
        }

        .table-wrapper {
            overflow-x: auto; /* 🔑 allows horizontal scroll */
            -webkit-overflow-scrolling: touch; /* smooth scrolling on mobile */
        }

            .table-wrapper table {
                min-width: 800px; /* Set a minimum width for table */
            }

        /* Table */
        table {
            border-collapse: collapse;
            margin-top: 15px;
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: auto;
            table-layout: fixed; /* 👈 fix column width */
            -webkit-overflow-scrolling: touch;
        }

            table th, table td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: center;
                word-wrap: break-word; /* 👈 text wrap thashe */
            }

        /* Column widths */
        /* Example: specific column widths */
        #salary-summary th:nth-child(1),
        #salary-summary td:nth-child(1) {
            width: 5%;
        }
        /* SR.NO */
        #salary-summary th:nth-child(2),
        #salary-summary td:nth-child(2) {
            width: 20%;
        }
        /* NAME */
        #salary-summary th:nth-child(3),
        #salary-summary td:nth-child(3) {
            width: 15%;
        }
        /* SALARY */
        #salary-summary th:nth-child(4),
        #salary-summary td:nth-child(4) {
            width: 10%;
        }
        /* WorkDay */
        #salary-summary th:nth-child(5),
        #salary-summary td:nth-child(5) {
            width: 15%;
        }
        /* NetSalary */
        #salary-summary th:nth-child(6),
        #salary-summary td:nth-child(6) {
            width: 10%;
        }
        /* Withdrw */
        #salary-summary th:nth-child(7),
        #salary-summary td:nth-child(7) {
            width: 10%;
        }
        /* BankSalary */
        #salary-summary th:nth-child(8),
        #salary-summary td:nth-child(8) {
            width: 15%;
        }
        /* Pay in Cash */

        /* Common input styling */
        .salary-input, .workday-input {
            width: 55px; /* 👈 nana width */
            padding: 4px 6px;
            font-size: 16px;
            text-align: center;
            border: 1px solid #999;
            border-radius: 6px;
        }

        th {
            background: #075e54;
            color: white;
            padding: 10px;
        }

        td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        tfoot th {
            background: #25d366;
            color: white;
        }
    </style>
</head>
<body>

    <div class="main-container">


        <!-- Dashboard -->
        <div id="dashboard" class="section card" style="text-align: center;">
            <h2>Dashboard</h2>
            <button class="dashboard-btn" onclick="showSection('add-entry')">➕ Add Entry</button>
            <button class="dashboard-btn" onclick="showEntries()">📄 View Entry</button>
            <button class="dashboard-btn" onclick="showSection('update-profile')">🛠 Update Profile</button>
            <button class="dashboard-btn" style="background:#34b7f1;" onclick="showSection('manage-salary')">💰 Manage Salary</button>
            <button class="dashboard-btn logout-btn" onclick="logout()">🚪 Logout</button>
        </div>

        <!-- Add Entry -->
        <div id="add-entry" class="section card" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Add Work Entry</h2>
                <button class="logout-btn" onclick="showSection('dashboard')">⬅ Back</button>
            </div>
            <div class="form-group">
                <label>Name:</label>
                <input type="text" id="name" readonly>
                <label>Date:</label>
                <input type="date" id="date" value="">
            </div>
            <div class="form-group"><label>ActivePart:</label><input type="number" id="active"></div>
            <div class="form-group"><label>Marking:</label><input type="number" id="marking"></div>
            <div class="form-group"><label>ReMarking:</label><input type="number" id="remarking"></div>
            <div class="form-group"><label>OutParty:</label><input type="number" id="outparty"></div>
            <div>
                <button class="btn-save" onclick="saveEntry()">💾 Save Entry</button>
            </div>
        </div>


        <!-- View Entry -->
        <div id="view-entry" class="section card card-white" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>All Entries</h2>
                <div>
                    <button class="btn-delete" onclick="deleteAllEntries()">🗑 Delete All Entries</button>
                    <button class="logout-btn" onclick="showSection('dashboard')">⬅ Back</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="entries-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Active</th>
                            <th>Marking</th>
                            <th>ReMarking</th>
                            <th>OutParty</th>
                            <th>ActivePartSalary</th>
                            <th>MarkingSalary</th>
                            <th>ReMarkingSalary</th>
                            <th>OutPartySalary</th>
                            <th>TotalSalary</th>
                        </tr>
                    </thead>
                    <tbody id="entries-body"></tbody>
                    <tfoot>
                        <tr id="total-row">
                            <th colspan="2">TOTAL</th>
                            <th id="t-active">0</th>
                            <th id="t-marking">0</th>
                            <th id="t-remarking">0</th>
                            <th id="t-outparty">0</th>
                            <th id="t-activeSalary">0.00</th>
                            <th id="t-markingSalary">0.00</th>
                            <th id="t-remarkingSalary">0.00</th>
                            <th id="t-outpartySalary">0.00</th>
                            <th id="t-totalSalary">0.00</th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>



            <!-- Update Profile -->
            <div id="update-profile" class="section card card-white" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Update Profile</h2>
                    <button class="logout-btn" onclick="showSection('dashboard')">⬅ Back</button>
                </div>
                <div class="form-group">
                    <label>User name:</label>
                    <input type="text" id="username">
                    <label>New Password:</label>
                    <input type="password" id="password">
                </div>
                <button class="update-btn" onclick="updateProfile()">🔒 Update Profile</button>
            </div>
            <!-- Manage Salary -->
            <div id="manage-salary" class="section card" style="display:none;">
                <h2>Manage Salary & Summary</h2>
                <button class="logout-btn" onclick="showSection('dashboard')">⬅ Back</button>
                <div class="table-wrapper">
                    <table id="salary-summary">
                        <thead>
                            <tr>
                                <th>SR.NO</th>
                                <th>NAME (Full Name)</th>
                                <th>SALARY (Total)</th>
                                <th>WorkDay</th>
                                <th>NetSalary</th>
                                <th>Withdrw</th>
                                <th>BankSalary</th>
                                <th>Pay In Cash</th>
                            </tr>
                        </thead>
                        <tbody id="salary-body"></tbody>
                    </table>

                    <!-- ✅ Withdraw History Box (inside Manage Salary only) -->
                    <div class="card" style="margin-top:20px;">
                        <h3 style="color:#075e54;">💳 Withdraw History</h3>
                        <table id="withdraw-history">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Date & Time</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="withdraw-body">
                                <tr><td colspan="3" style="text-align:center; color:gray;">No withdraw history</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

    <script>



        const firebaseConfig = {
            apiKey: "AIzaSyBcevmTwJ7T6xid6s-4csUm4UiFKUn7q_Q",
            authDomain: "my-work-update.firebaseapp.com",
            projectId: "my-work-update",
            storageBucket: "my-work-update.appspot.com", // ✅ FIX
            messagingSenderId: "521466697898",
            appId: "1:521466697898:web:071cb3372c2d686ead98d3"
        };

        window.onload = function () {
            let loggedUser = JSON.parse(localStorage.getItem('loggedUser') || '{}');

            // admin user manage માં save થયેલ fullname field load કરો
            if (loggedUser.fullname && loggedUser.fullname.trim() !== "") {
                document.getElementById('name').value = loggedUser.fullname;
            } else if (loggedUser.fullName && loggedUser.fullName.trim() !== "") {
                // જો ક્યાંક fullName key થી save થયેલું હોય તો fallback
                document.getElementById('name').value = loggedUser.fullName;
            } else if (loggedUser.username) {
                document.getElementById('name').value = loggedUser.username;
            } else {
                document.getElementById('name').value = "";
            }
            {
                loadWithdrawHistory();
            };
        };

        function logout() {
            if (confirm("Do you really want to logout?")) {
                localStorage.removeItem("loggedUser");
                window.location.href = "index.html";
            }
        }
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if (id === 'manage-salary') {
                loadSalarySummary();
            }
        }


        function saveEntry() {
            let name = document.getElementById('name').value.trim();
            let date = document.getElementById('date').value;

            let active = +document.getElementById('active').value.trim() || 0;
            let marking = +document.getElementById('marking').value.trim() || 0;
            let remarking = +document.getElementById('remarking').value.trim() || 0;
            let outparty = +document.getElementById('outparty').value.trim() || 0;

            if (active === 0 && marking === 0 && remarking === 0 && outparty === 0) {
                alert("Please enter your pcs");
                return;
            }

            let rates = { active: 2.6, marking: 2.3, remarking: 3.0, outparty: 2.6 };
            let activeSalary = active * rates.active;
            let markingSalary = marking * rates.marking;
            let remarkingSalary = remarking * rates.remarking;
            let outpartySalary = outparty * rates.outparty;
            let totalSalary = activeSalary + markingSalary + remarkingSalary + outpartySalary;

            let entry = {
                name, date, active, marking, remarking, outparty,
                activeSalary, markingSalary, remarkingSalary, outpartySalary, total: totalSalary,
                createdAt: new Date()
            };

            // 🔥 Check duplicate (same name + date)
            db.collection("workEntries")
                .where("name", "==", name)
                .where("date", "==", date)
                .get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        // 🔄 If entry exists → Update
                        let docId = snapshot.docs[0].id;
                        db.collection("workEntries").doc(docId).update(entry)
                            .then(() => {
                                alert("✏️ Entry Updated Successfully!");
                                resetForm(); // clear inputs
                            })
                            .catch(error => {
                                console.error("Error updating entry: ", error);
                                alert("❌ Error updating entry. Check console.");
                            });
                    } else {
                        // ➕ If no entry → Add new
                        db.collection("workEntries").add(entry)
                            .then(() => {
                                alert("✅ Entry Saved Successfully!");
                                resetForm(); // clear inputs
                            })
                            .catch(error => {
                                console.error("Error saving entry: ", error);
                                alert("❌ Error saving entry. Check console.");
                            });
                    }
                })
                .catch(error => {
                    console.error("Error checking duplicate: ", error);
                });
        }

        // 🧹 Function to clear all input fields
        function resetForm() {
            document.getElementById('date').value = "";
            document.getElementById('active').value = "";
            document.getElementById('marking').value = "";
            document.getElementById('remarking').value = "";
            document.getElementById('outparty').value = "";
        }






        function showEntries() {
            showSection('view-entry');

            let loggedUser = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            // 🟢 SAME field use karo je save vakhte kariye che
            let userName = loggedUser.fullname || loggedUser.fullName || loggedUser.username;

            console.log("📌 Current User for filter:", userName);

            let tbody = document.getElementById('entries-body');
            tbody.innerHTML = '';
            let total = {
                active: 0, marking: 0, remarking: 0, outparty: 0,
                activeSalary: 0, markingSalary: 0, remarkingSalary: 0, outpartySalary: 0, totalSalary: 0
            };

            // 🟢 first test without orderBy
            db.collection("workEntries")
                .where("name", "==", userName)
                .get()
                .then(snapshot => {
                    console.log("📦 Query result size:", snapshot.size);

                    if (snapshot.empty) {
                        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;color:gray;">No entries found</td></tr>`;
                        return;
                    }

                    let i = 1;
                    snapshot.forEach(doc => {
                        let e = doc.data();
                        console.log("➡️ Entry:", e);

                        tbody.innerHTML += `
                    <tr>
                        <td>${i++}</td>
                        <td>${e.date || '-'}</td>
                        <td>${e.active}</td>
                        <td>${e.marking}</td>
                        <td>${e.remarking}</td>
                        <td>${e.outparty}</td>
                        <td>${(e.activeSalary || 0).toFixed(2)}</td>
                        <td>${(e.markingSalary || 0).toFixed(2)}</td>
                        <td>${(e.remarkingSalary || 0).toFixed(2)}</td>
                        <td>${(e.outpartySalary || 0).toFixed(2)}</td>
                        <td>${(e.total || 0).toFixed(2)}</td>
                    </tr>`;

                        total.active += e.active;
                        total.marking += e.marking;
                        total.remarking += e.remarking;
                        total.outparty += e.outparty;
                        total.activeSalary += e.activeSalary;
                        total.markingSalary += e.markingSalary;
                        total.remarkingSalary += e.remarkingSalary;
                        total.outpartySalary += e.outpartySalary;
                        total.totalSalary += e.total;
                    });

                    // Update totals
                    document.getElementById('t-active').textContent = total.active;
                    document.getElementById('t-marking').textContent = total.marking;
                    document.getElementById('t-remarking').textContent = total.remarking;
                    document.getElementById('t-outparty').textContent = total.outparty;
                    document.getElementById('t-activeSalary').textContent = total.activeSalary.toFixed(2);
                    document.getElementById('t-markingSalary').textContent = total.markingSalary.toFixed(2);
                    document.getElementById('t-remarkingSalary').textContent = total.remarkingSalary.toFixed(2);
                    document.getElementById('t-outpartySalary').textContent = total.outpartySalary.toFixed(2);
                    document.getElementById('t-totalSalary').textContent = total.totalSalary.toFixed(2);
                })
                .catch(error => {
                    console.error("❌ Firestore query error:", error);
                    alert("Error fetching entries. Check console for details.");
                });
        }








        function deleteAllEntries() {
            if (!confirm("⚠️ Are you sure you want to delete all your entries?")) return;

            let loggedUser = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            let userName = loggedUser.fullname || loggedUser.fullName || loggedUser.username;

            if (!userName) {
                alert("❌ User not found. Please login again.");
                return;
            }

            db.collection("workEntries").where("name", "==", userName).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        alert("ℹ️ No entries found to delete.");
                        return;
                    }

                    let batch = db.batch();
                    snapshot.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    return batch.commit();
                })
                .then(() => {
                    alert("✅ All entries deleted successfully!");
                    document.getElementById('entries-body').innerHTML = ""; // clear table
                    // Reset totals
                    document.getElementById('t-active').textContent = 0;
                    document.getElementById('t-marking').textContent = 0;
                    document.getElementById('t-remarking').textContent = 0;
                    document.getElementById('t-outparty').textContent = 0;
                    document.getElementById('t-activeSalary').textContent = "0.00";
                    document.getElementById('t-markingSalary').textContent = "0.00";
                    document.getElementById('t-remarkingSalary').textContent = "0.00";
                    document.getElementById('t-outpartySalary').textContent = "0.00";
                    document.getElementById('t-totalSalary').textContent = "0.00";
                })
                .catch(error => {
                    console.error("Error deleting entries: ", error);
                    alert("❌ Error deleting entries. Check console.");
                });
        }



        function updateProfile() {
            let newName = document.getElementById("newFullName").value.trim();
            let newPassword = document.getElementById("newPassword").value.trim();
            let currentUser = JSON.parse(localStorage.getItem("loggedUser") || "null");

            if (!currentUser) {
                alert("યૂઝર મળ્યો નહીં.");
                return;
            }

            if (!newName || !newPassword) {
                alert("નવું નામ અને પાસવર્ડ નાખો.");
                return;
            }

            let users = JSON.parse(localStorage.getItem("users") || "[]");

            // old username match
            let index = users.findIndex(u => u.username === currentUser.username);
            if (index !== -1) {
                users[index].fullname = newName;
                users[index].password = newPassword;

                // update logged user too
                localStorage.setItem("loggedUser", JSON.stringify(users[index]));
                localStorage.setItem("users", JSON.stringify(users));

                document.getElementById("empName").value = newName;

                alert("✅ Profile successfully updated!");
            } else {
                alert("યૂઝર અપડેટ થયો નહિ.");
            }
        }
        function loadSalarySummary() {
            let loggedUser = JSON.parse(localStorage.getItem('loggedUser') || '{}');
            let userName = loggedUser.fullname || loggedUser.fullName || loggedUser.username;

            db.collection("workEntries")
                .where("name", "==", userName)
                .get()
                .then(snapshot => {
                    let totalSalary = 0;
                    snapshot.forEach(doc => {
                        let e = doc.data();
                        totalSalary += e.total || 0;
                    });

                    let tbody = document.getElementById('salary-body');
                    tbody.innerHTML = '';

                    let salaryPerDay = totalSalary / 26; // 26 working days
                    let payments = JSON.parse(localStorage.getItem('payments') || '{}');
                    let pay = payments[userName] || { workDays: 0, withdrw: 0, bank: 0 };
                    let netSalary = salaryPerDay * (pay.workDays || 0);
                    let payInCash = netSalary - (pay.withdrw || 0) - (pay.bank || 0);

                    tbody.innerHTML += `
                <tr>
                    <td>1</td>
                    <td>${userName}</td>
                    <td>${totalSalary.toFixed(2)}</td>
                    <td>${pay.workDays}</td>
                    <td>${netSalary.toFixed(2)}</td>
                    <td>${pay.withdrw}</td>
                    <td>${pay.bank}</td>
                    <td>${payInCash.toFixed(2)}</td>
                </tr>`;
                })
                .catch(error => {
                    console.error("❌ Error fetching salary summary:", error);
                    alert("Error fetching salary summary.");
                });
        }





        function updateBaki(input) {
            let row = input.closest('tr');
            let name = row.dataset.name;
            let totalSalary = parseFloat(row.cells[2].textContent) || 0;
            let salaryPerDay = totalSalary / 26;

            let workDays = parseFloat(row.cells[3].querySelector('input').value) || 0;
            let withdrw = parseFloat(row.cells[5].querySelector('input').value) || 0;
            let bank = parseFloat(row.cells[6].querySelector('input').value) || 0;

            let netSalary = salaryPerDay * workDays;
            row.querySelector('.net-salary').textContent = netSalary.toFixed(2);

            // ✅ Minus allowed
            let payInCash = netSalary - withdrw - bank;
            row.querySelector('.cash').textContent = payInCash.toFixed(2);

            let payments = JSON.parse(localStorage.getItem('payments') || '{}');
            if (!payments[name]) payments[name] = { workDays: 0, withdrw: 0, bank: 0, history: [] };

            // old withdraw value
            let oldWithdrw = payments[name].withdrw || 0;

            // ✅ If withdraw amount increased → add history with Date/Time
            if (withdrw > oldWithdrw) {
                let newAmount = withdrw - oldWithdrw;
                payments[name].history = payments[name].history || [];
                payments[name].history.push({
                    date: new Date().toLocaleString(), // ⏰ date+time
                    amount: newAmount
                });
            }

            payments[name].workDays = workDays;
            payments[name].withdrw = withdrw;
            payments[name].bank = bank;

            localStorage.setItem('payments', JSON.stringify(payments));

            // Refresh withdraw history (only for this user)
            loadWithdrawHistory(name);
        }



        function loadWithdrawHistory(userName) {
            let historyTableBody = document.getElementById("withdraw-body");
            historyTableBody.innerHTML = "";

            let payments = JSON.parse(localStorage.getItem('payments') || '{}');
            let sr = 1;

            if (userName && payments[userName] && payments[userName].history) {
                payments[userName].history.forEach(h => {
                    let row = document.createElement("tr");
                    row.innerHTML = `
                <td>${sr++}</td>
                <td>${h.date}</td>
                <td>${h.amount.toFixed(2)}</td>
            `;
                    historyTableBody.appendChild(row);
                });
            }

            if (historyTableBody.innerHTML === "") {
                historyTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:gray;">No Withdrawals Yet</td></tr>`;
            }
        }



        function loadWithdrawDetails() {
            let tableBody = document.getElementById("withdrawDetailsBody");
            tableBody.innerHTML = "";

            db.collection("payments").get().then(snapshot => {
                snapshot.forEach(doc => {
                    let data = doc.data();
                    if (data.history) {
                        data.history.forEach(h => {
                            let tr = document.createElement("tr");
                            tr.innerHTML = `
                        <td>${doc.id}</td>
                        <td>${h.date}</td>
                        <td>${h.amount}</td>
                    `;
                            tableBody.appendChild(tr);
                        });
                    }
                });
            });
        }

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();





        // Set today's date in Add Entry form
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
    </script>

</body>
</html>
